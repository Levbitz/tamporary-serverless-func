'use strict'

const { addErrorInfo } = require('../error/info')
const { addPluginLoadErrorStatus } = require('../status/load_error')
const { measureDuration } = require('../time/main')

const { load } = require('./child/load')
const { callChild } = require('./ipc')

// Retrieve all plugins commands
// Can use either a module name or a file path to the plugin.
const tLoadPlugins = async function ({ pluginsOptions, childProcesses, netlifyConfig, packageJson, debug }) {
  const pluginsCommands = await Promise.all(
    pluginsOptions.map((pluginOptions, index) =>
      loadPlugin(pluginOptions, { childProcesses, index, netlifyConfig, packageJson, debug }),
    ),
  )
  const pluginsCommandsA = pluginsCommands.flat()
  return { pluginsCommands: pluginsCommandsA }
}

const loadPlugins = measureDuration(tLoadPlugins, 'load_plugins')

// Retrieve plugin commands for one plugin.
// Do it by executing the plugin `load` event handler.
const loadPlugin = async function (
  { packageName, pluginPackageJson, pluginPackageJson: { version } = {}, pluginPath, inputs, loadedFrom, origin },
  { childProcesses, index, netlifyConfig, packageJson, debug },
) {
  const { childProcess } = childProcesses[index]
  const loadEvent = 'load'

  try {
<<<<<<< HEAD
    const { pluginCommands } = await callChild(childProcess, 'load', { pluginPath, inputs, netlifyConfig, packageJson })
=======
    const getPluginCommandsFunc = childProcess === undefined ? getCorePluginCommands : getProcessPluginCommands
    const pluginCommands = await getPluginCommandsFunc({
      packageName,
      pluginPackageJson,
      pluginPath,
      inputs,
      loadedFrom,
      origin,
      childProcess,
      netlifyConfig,
      packageJson,
      loadEvent,
    })
>>>>>>> ab792bb9f... Temp
    const pluginCommandsA = pluginCommands.map(({ event }) => ({
      event,
      packageName,
      loadedFrom,
      origin,
      pluginPackageJson,
      childProcess,
    }))
    return pluginCommandsA
  } catch (error) {
<<<<<<< HEAD
    addErrorInfo(error, {
      plugin: { packageName, pluginPackageJson },
      location: { event: loadEvent, packageName, loadedFrom, origin },
    })
    addPluginLoadErrorStatus({ error, packageName, version, debug })
    throw error
=======
    throw addPluginLoadErrorStatus({ error, packageName, version, debug })
>>>>>>> ab792bb9f... Temp
  }
}

const getCorePluginCommands = async function ({
  packageName,
  pluginPackageJson,
  pluginPath,
  inputs,
  loadedFrom,
  origin,
  netlifyConfig,
  packageJson,
  loadEvent,
}) {
  const { pluginsCommands, context } = load({ pluginPath, inputs, netlifyConfig, packageJson })
}

const getProcessPluginCommands = async function ({
  packageName,
  pluginPackageJson,
  pluginPath,
  inputs,
  loadedFrom,
  origin,
  childProcess,
  netlifyConfig,
  packageJson,
  loadEvent,
}) {
  const { pluginCommands } = await callChild(
    childProcess,
    'load',
    { pluginPath, inputs, netlifyConfig, packageJson },
    { plugin: { packageName, pluginPackageJson }, location: { event: loadEvent, packageName, loadedFrom, origin } },
  )
  return pluginCommands
}

module.exports = { loadPlugins }
