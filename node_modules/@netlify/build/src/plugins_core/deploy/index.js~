const { logDeploySuccess } = require('../../log/messages/plugins')

const { createClient, connectClient, closeClient, deploySiteWithClient } = require('./buildbot_client')

const onPostBuild = async function ({
  constants: { BUILDBOT_SERVER_SOCKET },
  events,
  utils: {
    build: { failBuild },
  },
}) {
  const client = createClient(BUILDBOT_SERVER_SOCKET)
  try {
<<<<<<< HEAD
    await connectBuildbotClient(client)
    await deploySiteWithBuildbotClient({ client, events, failBuild })
=======
    await connectClient(client)
    await deploySiteWithClient({ client, events, PUBLISH_DIR, failBuild })
>>>>>>> chore(lint): add `id-length` ESLint rule
    logDeploySuccess()
  } finally {
    await closeClient(client)
  }
}

module.exports = { onPostBuild }
